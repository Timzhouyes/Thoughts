---
layout:     post   				    # 使用的布局（不需要改）
title:      Redis浅析				# 标题 
subtitle:   对Redis的概念和用法的简析 #副标题
date:       2019-08-27 				# 时间
author:     Haiming 						# 作者
header-img: img/post-bg-2015.jpg 	#这篇文章标题背景图片
catalog: true 						# 是否归档
tags:								#标签
    - 编程
    - Redis
    - Web
---

参考资料：
为什么我们做分布式使用 Redis ？ - 程序之心 丁仪的文章 - 知乎
https://zhuanlan.zhihu.com/p/50392209

http://www.runoob.com/redis/redis-tutorial.html
# 1.为什么要使用redis
在项目之中使用redis，主要的考虑角度是性能和并发。
### 性能
由于在数据库之中查询数据是一项特别耗费资源的活动，因此遇到结果不会频繁变动的SQL，适合将结果直接放到缓存。
### 并发
在大并发的情况下，数据库直接处理所有请求会出现连接异常。这时候就使用Redis做一个缓冲操作，让请求先访问到Redis，再访问数据库。
### 使用Redis的常见问题
- 缓存和数据库双写一致性问题
- 缓存雪崩问题
- 缓存击穿问题
- 缓存的并发竞争问题

# 2. Redis简介
首先上定义：Redis是一个高性能的key-value数据库。
相比于其他产品，Redis有三个特点：
- Redis支持数据的持久化，可以将内存之中数据保存在磁盘之中，重启可以加载再使用。
- Redis不仅仅支持简单的key-value，还提供 list，set，zset，hash等结构存储。
- Redis支持数据的备份，即master-slave格式的备份。

# 3. Redis优势
- 性能高：读速度是110000次/s， 写速度是81000次/s
- 原子： Redis所有操作均为原子性

Redis和其他key-value产品不同在哪？
Redis可以将内存之中的数据不断存放在硬盘之中，我认为这一点设计极其精巧，因为内存的存取结构远比硬盘简单，而且在向硬盘上面追加数据的时候，是顺序写，可以最大限度的提高性能。

# 4.一些配置文件：
http://www.runoob.com/redis/redis-conf.html

1. `vm-page-size 32` ： Redis swap 文件分成了很多的page，一个Object可以保存在多个page上面，但是一个page不可以被多个Object共享，这一项是根据存储的数据大小来设定的，若存储很多小对象，page大小最好设置32或者64bytes，存储很大的对象，可以用更大的page。
2. `vm-max-memory 0`: 将所有大于 vm-max-memory 的数据写入虚拟内存，无论 vm-max-memory 设置多小。所有索引数据都是内存存储的，也就是说当vm-max-memory设置为0，就是所有value存储到磁盘。默认为0.
3. `maxmemory <bytes>`: 指定Redis的最大内存限制。Redis在启动时候会将数据加载到内存之中，达到最大内存之后，Redis会先尝试清除已到期或者即将到期的key，在这种方法处理之后，仍然达到最大的内存限制，将无法使用写入操作。Redis新的vm机制，会将Key放到内存，Value放到swap区。

# 5. Redis数据类型
Redis数据库之中的key总是一个String Object
数据库的值可以为string，hash，list，set，zset(sorted set:有序集合)。
### String
String是Redis最基本的类型，一个key对应一个value，string是二进制安全的，也就是说Redis的String可以包含任何数据，比如jpg图片或者序列化的对象。
String能存储的最大值是512MB

```
redis 127.0.0.1:6379> SET name "runoob"
OK
redis 127.0.0.1:6379> GET name
"runoob"
```

### Hash
Redis Hash 是一个 key-value 对的集合。
Redis 是一个string类型的field和value的映射表，适用于存储对象

```
redis 127.0.0.1:6379> DEL runoob
redis 127.0.0.1:6379> HMSET runoob field1 "Hello" field2 "World"
"OK"
redis 127.0.0.1:6379> HGET runoob field1
"Hello"
redis 127.0.0.1:6379> HGET runoob field2
"World"
```

HMSET,HGET是用来设置键值对的命令。

### List
Redis列表是简单的字符串列表，按照插入顺序排序。可以添加一个元素到列表的头部（左边）或者尾部（右边）
```
redis 127.0.0.1:6379> DEL runoob
redis 127.0.0.1:6379> lpush runoob redis
(integer) 1
redis 127.0.0.1:6379> lpush runoob mongodb
(integer) 2
redis 127.0.0.1:6379> lpush runoob rabitmq
(integer) 3
redis 127.0.0.1:6379> lrange runoob 0 10
1) "rabitmq"
2) "mongodb"
3) "redis"
redis 127.0.0.1:6379>
```
lpush, lrange是用来存和取的命令。列表最多可以存储 $ 2^32-1 $ 个元素。

### Set
Redis的Set是string类型的无序集合，集合是通过Hash表实现的，所以其添加，删除，查找的复杂度都是O(1)

```
redis 127.0.0.1:6379> DEL runoob
redis 127.0.0.1:6379> sadd runoob redis
(integer) 1
redis 127.0.0.1:6379> sadd runoob mongodb
(integer) 1
redis 127.0.0.1:6379> sadd runoob rabitmq
(integer) 1
redis 127.0.0.1:6379> sadd runoob rabitmq
(integer) 0
redis 127.0.0.1:6379> smembers runoob

1) "redis"
2) "rabitmq"
3) "mongodb"
```

上述的例子之中rabitmq添加了两次，但是根据唯一性，第二次插入的元素会被忽略， 所以直接返回0

### zset(sorted set:有序集合)
Redis的zset与set不同的一点是，每一个元素都会关联一个double类型的分数。Redis通过这种double类型的分数来为集合之中的成员进行**从小到大**的排序。
zset也是set，所以其成员仍是唯一的，但是score可以重复。

zadd命令：
添加元素到集合。如果在集合之中元素本身存在，则更新对应的score。
`zadd key score member`

```
redis 127.0.0.1:6379> DEL runoob
redis 127.0.0.1:6379> zadd runoob 0 redis
(integer) 1
redis 127.0.0.1:6379> zadd runoob 0 mongodb
(integer) 1
redis 127.0.0.1:6379> zadd runoob 0 rabitmq
(integer) 1
redis 127.0.0.1:6379> zadd runoob 0 rabitmq
(integer) 0
redis 127.0.0.1:6379> > ZRANGEBYSCORE runoob 0 1000
1) "mongodb"
2) "rabitmq"
3) "redis"
```

注意上面命令之中的 `ZRANGEBYSCORE runoob 0 1000` 是对于score在0到1000的项按照升序排序。

# 6.Redis命令

在远程 Redis 服务执行命令：

`redis-cli -h host -p port -a password`

下面的命令是连接到主机为`127.0.0.1`，端口为6379，密码我为mypass的Redis服务的示例：

```c
$redis-cli -h 127.0.0.1 -p 6379 -a "mypass"
redis 127.0.0.1:6379>
redis 127.0.0.1:6379> PING

PONG
```

# 7. Redis 基本类型

## 7.1 Redis Key

Redis key 命令的基本语法如下：

`redis 127.0.0.1:6379> COMMAND KEY_NAME`

示例：

```
redis 127.0.0.1:6379> SET runoobkey redis
OK
redis 127.0.0.1:6379> DEL runoobkey
(integer) 1
```

返回1表示操作成功，若未成功，则会返回0。

下面是Redis key操作的操作符，可以看出来其除了对于 Key 做CRUD的操作之外，还有一些操作符是对于key的过期时间进行设置的，这也同样表明了Redis作为缓存，需要不断刷新自己内部资源和对某些过期资源进行处理的特点。

| 序号 | 命令及描述                                                   |
| :--- | :----------------------------------------------------------- |
| 1    | [DEL key](http://www.runoob.com/redis/keys-del.html) 该命令用于在 key 存在时删除 key。 |
| 2    | [DUMP key](http://www.runoob.com/redis/keys-dump.html)  序列化给定 key ，并返回被序列化的值。 |
| 3    | [EXISTS key](http://www.runoob.com/redis/keys-exists.html)  检查给定 key 是否存在。 |
| 4    | [EXPIRE key](http://www.runoob.com/redis/keys-expire.html) seconds 为给定 key 设置过期时间，以秒计。 |
| 5    | [EXPIREAT key timestamp](http://www.runoob.com/redis/keys-expireat.html)  EXPIREAT 的作用和 EXPIRE 类似，都用于为 key 设置过期时间。 不同在于 EXPIREAT 命令接受的时间参数是 UNIX 时间戳(unix timestamp)。 |
| 6    | [PEXPIRE key milliseconds](http://www.runoob.com/redis/keys-pexpire.html)  设置 key 的过期时间以毫秒计。 |
| 7    | [PEXPIREAT key milliseconds-timestamp](http://www.runoob.com/redis/keys-pexpireat.html)  设置 key 过期时间的时间戳(unix timestamp) 以毫秒计 |
| 8    | [KEYS pattern](http://www.runoob.com/redis/keys-keys.html)  查找所有符合给定模式( pattern)的 key 。 |
| 9    | [MOVE key db](http://www.runoob.com/redis/keys-move.html)  将当前数据库的 key 移动到给定的数据库 db 当中。 |
| 10   | [PERSIST key](http://www.runoob.com/redis/keys-persist.html)  移除 key 的过期时间，key 将持久保持。 |
| 11   | [PTTL key](http://www.runoob.com/redis/keys-pttl.html)  以毫秒为单位返回 key 的剩余的过期时间。 |
| 12   | [TTL key](http://www.runoob.com/redis/keys-ttl.html)  以秒为单位，返回给定 key 的剩余生存时间(TTL, time to live)。 |
| 13   | [RANDOMKEY](http://www.runoob.com/redis/keys-randomkey.html)  从当前数据库中随机返回一个 key 。 |
| 14   | [RENAME key newkey](http://www.runoob.com/redis/keys-rename.html)  修改 key 的名称 |
| 15   | [RENAMENX key newkey](http://www.runoob.com/redis/keys-renamenx.html)  仅当 newkey 不存在时，将 key 改名为 newkey 。 |
| 16   | [TYPE key](http://www.runoob.com/redis/keys-type.html)  返回 key 所储存的值的类型。 |

## 7.2 Redis String

Redis String 类型用于管理Redis字符串值，基本语法如下：

`redis 127.0.0.1:6379> COMMAND KEY_NAME`

示例：

```
redis 127.0.0.1:6379> SET runoobkey redis
OK
redis 127.0.0.1:6379> GET runoobkey
"redis"
```

可以看到此处的第一个命令和上面的并无任何不同，其作用为：set一个key为 runoobkey 的String Object

下面是一些String Object相关的命令，可看到其本身除了基本的CRUD之外，还有针对于String 类型的操作符，类似于移位，截取片段，若是数字则数字+n等等，具有较强的灵活操作性。除此之外，还有些类似于 `GETSET` 的命令，在拿到值之后改变值，将CRUD之中的几种进行组合，非常灵活。

| 序号 | 命令及描述                                                   |
| :--- | :----------------------------------------------------------- |
| 1    | [SET key value](http://www.runoob.com/redis/strings-set.html)  设置指定 key 的值 |
| 2    | [GET key](http://www.runoob.com/redis/strings-get.html)  获取指定 key 的值。 |
| 3    | [GETRANGE key start end](http://www.runoob.com/redis/strings-getrange.html)  返回 key 中字符串值的子字符 |
| 4    | [GETSET key value](http://www.runoob.com/redis/strings-getset.html) 将给定 key 的值设为 value ，并返回 key 的旧值(old value)。 |
| 5    | [GETBIT key offset](http://www.runoob.com/redis/strings-getbit.html) 对 key 所储存的字符串值，获取指定偏移量上的位(bit)。 |
| 6    | [MGET key1 [key2..\]](http://www.runoob.com/redis/strings-mget.html) 获取所有(一个或多个)给定 key 的值。 |
| 7    | [SETBIT key offset value](http://www.runoob.com/redis/strings-setbit.html) 对 key 所储存的字符串值，设置或清除指定偏移量上的位(bit)。 |
| 8    | [SETEX key seconds value](http://www.runoob.com/redis/strings-setex.html) 将值 value 关联到 key ，并将 key 的过期时间设为 seconds (以秒为单位)。 |
| 9    | [SETNX key value](http://www.runoob.com/redis/strings-setnx.html) 只有在 key 不存在时设置 key 的值。 |
| 10   | [SETRANGE key offset value](http://www.runoob.com/redis/strings-setrange.html) 用 value 参数覆写给定 key 所储存的字符串值，从偏移量 offset 开始。 |
| 11   | [STRLEN key](http://www.runoob.com/redis/strings-strlen.html) 返回 key 所储存的字符串值的长度。 |
| 12   | [MSET key value [key value ...\]](http://www.runoob.com/redis/strings-mset.html) 同时设置一个或多个 key-value 对。 |
| 13   | [MSETNX key value [key value ...\]](http://www.runoob.com/redis/strings-msetnx.html)  同时设置一个或多个 key-value 对，当且仅当所有给定 key 都不存在。 |
| 14   | [PSETEX key milliseconds value](http://www.runoob.com/redis/strings-psetex.html) 这个命令和 SETEX 命令相似，但它以毫秒为单位设置 key 的生存时间，而不是像 SETEX 命令那样，以秒为单位。 |
| 15   | [INCR key](http://www.runoob.com/redis/strings-incr.html) 将 key 中储存的数字值增一。 |
| 16   | [INCRBY key increment](http://www.runoob.com/redis/strings-incrby.html) 将 key 所储存的值加上给定的增量值（increment） 。 |
| 17   | [INCRBYFLOAT key increment](http://www.runoob.com/redis/strings-incrbyfloat.html) 将 key 所储存的值加上给定的浮点增量值（increment） 。 |
| 18   | [DECR key](http://www.runoob.com/redis/strings-decr.html) 将 key 中储存的数字值减一。 |
| 19   | [DECRBY key decrement](http://www.runoob.com/redis/strings-decrby.html) key 所储存的值减去给定的减量值（decrement） 。 |
| 20   | [APPEND key value](http://www.runoob.com/redis/strings-append.html) 如果 key 已经存在并且是一个字符串， APPEND 命令将指定的 value 追加到该 key 原来值（value）的末尾。 |

## 7.3 Redis Hash

Redis hash 是一个 string 类型的 field 和 value 的映射表，hash 特别适合用于存储对象。

Redis 中每个 hash 可以存储 2^32 - 1 键值对（40多亿）。

下面是一个例子：

```c
127.0.0.1:6379>  HMSET runoobkey name "redis tutorial" description "redis basic commands for caching" likes 20 visitors 23000
OK
127.0.0.1:6379>  HGETALL runoobkey
1) "name"
2) "redis tutorial"
3) "description"
4) "redis basic commands for caching"
5) "likes"
6) "20"
7) "visitors"
8) "23000"
```

在这个例子之中，我遇到了以下几个问题：

1. 在 `runoobkey'` 之后的argument必须是2的倍数。也就是在这里，我清楚了提到的“是一个String类型的field和value的映射表”这句话的含义。上午的学习之中没有搞清楚到底Hash类型和String类型的差别在哪，现在看来，一个Hash类型之中所容纳的是很多的String类型的key-value对。
2. 在第一次输入命令时候没有反应，想着重启大法好，直接重启 `redis-cli` 没有任何反应，最后连  `redis-server` 一起重启才正常运作。没有反应期间电脑各项指标全部正常，也没有任何的报错信息，在Google查找无反应原因也并未有自己相关的答案，因此只能求助重启大法了。